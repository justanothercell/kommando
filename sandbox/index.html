<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <script src="https://cdn.jsdelivr.net/npm/ansi_up@4.0.4/ansi_up.js"></script>
		<link rel="stylesheet" data-name="vs/editor/editor.main" href="https://unpkg.com/monaco-editor/min/vs/editor/editor.main.css"/>
		<link rel="stylesheet" href="./editor.css"/>
	</head>
	<body>
        <h1>
            <a href="https://github.com/justanothercell/kommando/tree/dev" target="_blank" rel="noopener noreferrer" style="color:white">Kommando sandbox</a> |
            <a href="/docs" target="_blank" rel="noopener noreferrer" style="color:white">Docs[WIP]</a>
        </h1>
        <div id="header">
            <button id="button-run">Run</button>
            <input type="checkbox" id="show-compiler-output"><label id="show-compiler-output-label">Compiler<br>Output</label>
            <input id="compiler-flags" placeholder="compiler flags | try --help for a list of options">
        </div>
        <div id="main">
            <div id="editor"></div>
            <div id="draggable-divider"></div>
            <div id="output"></div>
        </div>

        <script>
            var divider = document.getElementById('draggable-divider');

            divider.onmousedown = (e) => {
                document.onmouseup = (e) => {
                    document.onmouseup = null;
                    document.onmousemove = null;
                };
                document.onmousemove = (e) => {
                    let main = document.getElementById('main');
                    let editor = document.getElementById('editor');
                    let w = Math.min(e.clientX - editor.offsetLeft - 8, main.clientWidth - 11);
                    editor.style.minWidth = w + "px";
                    editor.style.width = w + "px";
                    editor.style.maxWidth = w + "px";
                };
            };
        </script>

		<script>
			var require = { paths: { vs: 'https://unpkg.com/monaco-editor/min/vs' } };
		</script>
		<script src="https://unpkg.com/monaco-editor/min/vs/loader.js"></script>
		<script src="https://unpkg.com/monaco-editor/min/vs/editor/editor.main.js"></script>
		<script>
			var editor = monaco.editor.create(document.getElementById('editor'), {
				value: 'use std::*;\n\nfn main() {\n    println("Hello, world!");\n}',
				language: 'rust',
                theme: 'vs-dark',
                automaticLayout: true
			});

            document.onkeydown = (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    run();
                }
            };
            const run_button = document.getElementById('button-run');
            const compiler_flags = document.getElementById('compiler-flags');
            const compiler_output = document.getElementById('show-compiler-output')
            run_button.onclick = (e) => run();
            const output = document.getElementById('output');
            const ansi_up = new AnsiUp();
            
            var exec_state = 'idle';

            function html_escape(text) {
                return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;").replace(/\\/g, "&#92;");
            }

            function editor_jump_to(loc) {
                const range = editor.getModel().getFullModelRange();
                if (loc.length > 0) { 
                    if (loc.length == 1) { // line
                        editor.setPosition( { lineNumber: loc[0], column: 0 });
                    }
                    if (loc.length == 2) { // line+col
                        editor.setPosition( { lineNumber: loc[0], column: loc[1] });
                    }
                    if (loc.length == 3) { // line+range
                        editor.setSelection({ startLineNumber: loc[0], endLineNumber: loc[0], startColumn: loc[1], endColumn: loc[2] });
                    }
                    editor.revealLine(loc[0]);
                }
                editor.focus();
            }

            function linkify_output_text(text) {
                let parts = []
                for (let part of text.split(/(\.?\/?\w+(?:\/\w+)*\.\w+(?::\d+(?::\d+)?(?:-\d+)?)?)/g)) {
                    if (!part) continue;
                    if (/^\.?\/?\w+(?:\/\w+)*\.\w+(?::\d+(?::\d+)?(?:-\d+)?)?$/.test(part)) {
                        let [_empty, file, suffix] = part.split(/^(\.?\/?\w+(?:\/\w+)*\.\w+)/);
                        let loc = suffix.match(/(\d+)/g);
                        if (/^\/tempdata\/sandbox[0-9a-f]+.kdo$/.test(file)) { // main kdo file
                            parts.push('<a href="#" onclick="event.preventDefault();editor_jump_to([' + loc + ']);" style="color: inherit">' + html_escape(part) + '</a>');
                        } else {
                            let href = '';
                            let github_prefix = 'https://github.com/justanothercell/kommando/blob/dev/';
                            let github_suffix = '';
                            if (loc.length > 0) github_suffix = '#L' + loc[0];
                            if (/^\/tempdata\/sandbox[0-9a-f]+.c$/.test(file)) { // generated c file, inaccessible
                                parts.push(html_escape(part));
                            } else if (/^\/tempdata\/sandbox[0-9a-f]+.h$/.test(file)) { // generated c header file, inaccessible
                                continue;
                                parts.push(html_escape(part));
                                continue;
                            } else if (/^\.?\/kdolib.*.kdo$/.test(file)) { // library file
                                href = github_prefix + file + github_suffix;
                            } else if (/^\w+(\/\w+)*.c$/.test(file)) { // bootstrap source file
                                href = github_prefix + 'bootstrap/' + file + github_suffix;
                            } else { // unknown, raw link
                                parts.push(html_escape(part));
                                continue;
                            }
                            // clickable link
                            parts.push('<a href="' + href + '" target="_blank" rel="noopener noreferrer" style="color: inherit">' + html_escape(part) + '</a>');
                        }
                    } else {
                        parts.push(html_escape(part));
                    }
                }
                return parts.join('');
            }

            function set_output(text){
                output.innerHTML = ansi_up.ansi_to_html(text);
                for (const node of output.childNodes) {
                    if (node.nodeType === Node.TEXT_NODE && node.nodeValue.trim() !== "") {
                        let span = document.createElement("span");
                        span.innerHTML = linkify_output_text(node.textContent);
                        output.replaceChild(span, node);
                    } else {
                        node.innerHTML = linkify_output_text(node.textContent);
                    }
                }
            }

            function run() {
                save();
                if (exec_state != 'idle') return;
                exec_state = 'running';
                output.innerHTML = 'Executing...';
                let flags = compiler_flags.value;
                let show_output = compiler_output.checked;
                let code = editor.getValue();
                let i = 0;
                let handler = setInterval(() => {
                    i += 1;
                    run_button.innerHTML = '.'.repeat(i % 3 + 1);
                    if (exec_state == 'idle') {
                        clearInterval(handler);
                        run_button.innerHTML = 'Run';
                    }
                }, 350);
                fetch('/execute', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ compiler_flags: flags, show_compiler_output: show_output, code: code })
                })
                .then((response) => {
                    if (response.status != 200) {
                        set_output('\x1b[1;37mError executing:\n' + response.statusText + '\x1b[0m');
                        exec_state = 'idle';
                        return;
                    }
                    return response.json()
                }).then((json) => {
                    if (!json) return;
                    if (json['success']) {
                        set_output(json['output'] + '\n\x1b[1;37mProcess exited with code ' + json['exit_code'] + '\x1b[0m');
                    } else {
                        set_output('\x1b[1;37mCompilation error:\x1b[0m\n' + json['output'] + '\n\x1b[1;37mProcess exited with code ' + json['exit_code'] + '\x1b[0m');
                    }
                    exec_state = 'idle';
                }).finally(() => {
                    exec_state = 'idle'; // just in case 
                    output.scrollTop = output.scrollHeight;
                });
            }

            function load() {
                let flags = localStorage.getItem('editor.flags');
                let show_output = localStorage.getItem('editor.show_output');
                let code = localStorage.getItem('editor.code');
                if (flags != null) compiler_flags.value = flags;
                if (show_output != null) compiler_output.checked = show_output == 'true';
                if (code != null) editor.setValue(code);
            }

            function save() {
                let flags = compiler_flags.value;
                let show_output = compiler_output.checked;
                let code = editor.getValue();
                localStorage.setItem('editor.flags', flags);
                localStorage.setItem('editor.show_output', show_output);
                localStorage.setItem('editor.code', code);
            }

            window.onunload = save;
            load();
            run();
		</script>
	</body>
</html>